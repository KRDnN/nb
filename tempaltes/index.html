<!-- index.html -->
{% extends "base.html" %}
{% block title %}홈 | 안전 관리 매니저{% endblock %}

{% block content %}
<h2>안전 관리 매니저</h2>
<form id="rtsp-form" method="POST" style="margin-bottom:12px;">
    <input type="text" name="rtsp_url" id="rtsp_url" placeholder="RTSP 주소 입력" value="{{ rtsp_url or '' }}" style="width:380px;">
    <button type="submit">연결</button>
</form>
<div style="display:flex;gap:36px;">
    <div>
        <h3>RTSP 실시간 영상</h3>
        <div style="position:relative; width:640px;">
            <img id="rtsp-frame" src="{{ url_for('video_feed') if rtsp_url else '' }}" width="640" height="480"
                style="background:#222;">
            <canvas id="overlay" width="640" height="480"
                style="position:absolute;left:0;top:0;pointer-events:none;"></canvas>
        </div>
        <div id="project-match-info" style="margin-top:8px;color:#206;font-size:1.05em;"></div>
    </div>
    <div>
        <h3>내 프로젝트</h3>
        <div class="project-list">
            {% for project in projects %}
            <div class="project-item" onclick="selectProject('{{ project }}')">
                <b>{{ project }}</b>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<style>
.project-list {
    display:flex; flex-direction:column; gap:14px; margin-top:10px;
}
.project-item {
    padding:10px 18px; border:1px solid #ccd; border-radius:8px; cursor:pointer;
    font-size:1.08em; background:#f6f8fb; transition:background 0.18s;
}
.project-item:hover { background:#e2e8fa; }
</style>
<script>
let selectedProject = "";
let rtspPlaying = {{ "true" if rtsp_url else "false" }};
let overlayImg = null, overlayZone = [];

// 프로젝트 클릭 → RTSP와 매칭/오버레이
function selectProject(name){
    selectedProject = name;
    document.getElementById('project-match-info').innerText = "매칭 중...";
    fetch("/rtsp_match_overlay", {
        method:"POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
            rtsp_url: document.getElementById('rtsp_url').value,
            project: name
        })
    }).then(res=>res.json()).then(data=>{
        if(data.frame){
            overlayImg = new Image();
            overlayImg.onload = ()=>drawOverlayImg(data.zones);
            overlayImg.src = "data:image/jpeg;base64," + data.frame;
            overlayZone = data.zones;
            document.getElementById('project-match-info').innerText = `프로젝트: ${name} | 매칭프레임: ${data.match_idx} | 매칭률: ${Math.round(data.score*100)}%`;
        }else{
            overlayImg = null;
            drawOverlayImg([]);
            document.getElementById('project-match-info').innerText = "매칭 실패";
        }
    });
}

// RTSP 영상 위에 매칭된 프레임 오버레이 + 위험구역(폴리곤)
function drawOverlayImg(zones){
    const cvs = document.getElementById('overlay');
    const ctx = cvs.getContext('2d');
    ctx.clearRect(0,0,640,480);
    if(overlayImg){
        ctx.globalAlpha = 0.8; // 80% 투명
        ctx.drawImage(overlayImg, 0,0,640,480);
        ctx.globalAlpha = 1.0;
    }
    // 위험구역(폴리곤) 오버레이
    for(let pts of zones){
        if(pts.length<3) continue;
        ctx.beginPath();
        ctx.moveTo(pts[0][0], pts[0][1]);
        for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i][0], pts[i][1]);
        ctx.closePath();
        ctx.strokeStyle = "#ee0000";
        ctx.lineWidth = 2.4;
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = "rgba(255,0,0,0.25)";
        ctx.fill();
        ctx.stroke();
        ctx.globalAlpha = 1.0;
    }
}
</script>
{% endblock %}
