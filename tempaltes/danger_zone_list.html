{% extends "base.html" %}
{% block title %}ìœ„í—˜êµ¬ì—­ ê´€ë¦¬{% endblock %}

{% block content %}
<h2>âš  ìœ„í—˜êµ¬ì—­ ê´€ë¦¬</h2>
<div style="display: flex; gap:32px;">
    <!-- ì¢Œì¸¡: ë™ì˜ìƒ ë¦¬ìŠ¤íŠ¸ -->
    <div style="width: 220px;">
        <h4 style="margin-bottom: 10px;">ë‚´ ë™ì˜ìƒ</h4>
        <div>
        {% for video in videos %}
            <div class="video-item" onclick="selectVideo('{{ video.name }}')"
                style="margin-bottom:18px; cursor:pointer; border-radius:8px; padding:6px 3px; {{'background:#f3f7fc;' if video.name==selected_video else ''}}">
                <img src="{{ url_for('static', filename=video.thumb) }}" class="thumb" style="width:100%; border-radius:6px;">
                <div class="video-info" style="margin-top:5px;">
                    <b>{{ video.name }}</b><br>
                    <span style="font-size:0.98em;color:#555;">{{ video.resolution }}</span>
                </div>
            </div>
        {% else %}
            <div style="color:gray;">ë“±ë¡ëœ ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>
        {% endfor %}
        </div>
    </div>

    <!-- ìš°ì¸¡: ìœ„í—˜êµ¬ì—­ ì§€ì • -->
    <div style="flex:1;">
        {% if selected_video %}
        <h4>{{ selected_video }}</h4>
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px; flex-wrap: wrap;">
            <!-- 1. ìœ„í—˜êµ¬ì—­ ID/ìƒˆ ìœ„í—˜êµ¬ì—­/ì‚­ì œ ê·¸ë£¹ -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin-right:2px;">ID:</label>
                <select id="zoneSelect" style="min-width:60px;"></select>
                <button onclick="addNewZone()">+ ìƒˆ ìœ„í—˜êµ¬ì—­</button>
                <button onclick="deleteZone()">ğŸ—‘ ì‚­ì œ</button>
            </div>
            <!-- 2. ìœ„í—˜êµ¬ì—­ ê¸°ëŠ¥ ë²„íŠ¼ ê·¸ë£¹ -->
            <div style="display: flex; align-items: center; gap: 7px;">
                <button onclick="playFrames()">â–¶ï¸ ì¬ìƒ</button>
                <button onclick="pauseFrames()">â¸ ì •ì§€</button>
                <button id="start-poly-btn" onclick="startPoly()">ìœ„í—˜êµ¬ì—­ ì§€ì • ì‹œì‘</button>
                <button id="end-poly-btn" onclick="endPoly()" style="display:none;">ìœ„í—˜êµ¬ì—­ ì§€ì • ì™„ë£Œ</button>
                <button onclick="editZone()">ë‹¤ì‹œì§€ì •</button>
            </div>
            <!-- 3. ORB ê´€ë ¨ ë²„íŠ¼/ìƒíƒœ ê·¸ë£¹ (ì˜¤ë¥¸ìª½ ë) -->
            <div style="display: flex; align-items: center; gap: 7px; margin-left:auto;">
                <button id="extract-all-orb-btn" onclick="extractAllORB()">ğŸ” ORB ì „ì²´ ì¶”ì¶œ</button>
                <button id="visualize-orb-btn" onclick="visualizeAllORB()" style="display:none;">ğŸŒˆ ORB ì‹œê°í™”</button>
                <span id="orb-all-status" style="margin-left:7px; color:#126; min-width:100px;"></span>
            </div>
        </div>
        <canvas id="frame-canvas" width="640" height="480" style="border:1.5px solid #aaa; border-radius:8px; background:#222;"></canvas>
        <div style="margin-top:7px;">
            <input type="range" id="slider" min="0" max="{{ frame_count-1 }}" value="0" style="width:410px;" oninput="moveFrame(this.value)">
            <span id="cur-frame">0</span>
        </div>
        <div id="thumbs" style="display:flex; gap:6px; margin-top:6px; overflow-x:auto; width:640px;"></div>
        <div style="margin:16px 0;">
            <button onclick="saveDangerZones()">ğŸ’¾ ì €ì¥</button>
            <span id="zone-info" style="margin-left:16px; color:#656;"></span>
        </div>
        {% else %}
        <div style="margin:80px;color:#888;">ë™ì˜ìƒì„ ì„ íƒí•˜ë©´ ìœ„í—˜êµ¬ì—­ ì§€ì • í™”ë©´ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        {% endif %}
    </div>
</div>
<script>
let selectedVideo = "{{ selected_video or '' }}";
let frameIdx = 0, maxFrames = {{ frame_count or 0 }};
let zones = {{ zones|tojson }};
let currentZoneId = null;
let orbAll = null, orbViz = false, polyDrawing = false, polyPoints = [];
let playTimer = null;
let polyHistory = {};

// í•´ë‹¹ í”„ë ˆì„ì˜ polygon ë°˜í™˜
function getPolygonForFrame(zoneId, idx) {
    if (polyHistory[zoneId] && polyHistory[zoneId][idx] && polyHistory[zoneId][idx].length >= 3)
        return polyHistory[zoneId][idx];
    if (zones[zoneId] && zones[zoneId].points && zones[zoneId].points.length >= 3)
        return zones[zoneId].points;
    return [];
}

const canvas = document.getElementById('frame-canvas');
const ctx = canvas ? canvas.getContext('2d') : null;

function selectVideo(name){ window.location = "/zones?video=" + encodeURIComponent(name); }
function makeThumbnails(){
    let thumbsHtml = '';
    let step = Math.max(1, Math.floor(maxFrames/32));
    for(let i=0;i<maxFrames;i+=step)
      thumbsHtml += `<img src="/frame/${selectedVideo}/${i}" onclick="moveFrame(${i})" id="thumb${i}" style="width:32px;height:22.5px;">`;
    document.getElementById('thumbs').innerHTML = thumbsHtml;
}
function moveFrame(idx){
    frameIdx = parseInt(idx);
    loadFrame(frameIdx);
    document.querySelectorAll('#thumbs img').forEach(el=>el.classList.remove('selected'));
    let thumb = document.getElementById('thumb'+idx);
    if(thumb) thumb.classList.add('selected');
}
function loadFrame(idx) {
    if (!selectedVideo) return;
    const img = new Image();
    img.onload = function() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        if (orbViz && orbAll && orbAll[idx]) drawORB(idx);
        drawZones(idx);
    };
    img.src = `/frame/${selectedVideo}/${idx}`;
    document.getElementById('cur-frame').innerText = idx;
    document.getElementById('slider').value = idx;
}
function playFrames(){
    pauseFrames();
    if (!currentZoneId || getPolygonForFrame(currentZoneId, frameIdx).length < 3) {
        alert('ìœ„í—˜êµ¬ì—­ì„ ì§€ì •í•´ì•¼ ì¬ìƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }
    playTimer = setInterval(async ()=>{
        // íˆìŠ¤í† ë¦¬ ê¸°ë°˜ íŠ¸ë˜í‚¹
        if (currentZoneId && getPolygonForFrame(currentZoneId, frameIdx).length >= 3 && frameIdx+1 < maxFrames) {
            let curPoly = getPolygonForFrame(currentZoneId, frameIdx);

            // === [ìˆ˜ì •] ===
            // fetch('/track_polygon', ...) => fetch('/track_zone_history', ...)
            // ë°˜í™˜ê°’: {history: [{frame, points}, ...]} â†’ ë‹¤ìŒ í”„ë ˆì„ì€ history[1].points
            let res = await fetch(`/track_zone_history`, {
                method: "POST",
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    filename: selectedVideo,
                    from_frame: frameIdx,
                    to_frame: frameIdx+1,
                    polygon: curPoly
                })
            });
            let data = await res.json();
            if (!polyHistory[currentZoneId]) polyHistory[currentZoneId] = {};
            if (data.history && data.history.length >= 2)
                polyHistory[currentZoneId][frameIdx+1] = data.history[1].points;
        }
        frameIdx = (frameIdx+1) % maxFrames;
        loadFrame(frameIdx);
    }, 180);
}
function pauseFrames(){
    if (playTimer) {
        clearInterval(playTimer);
        playTimer = null;
    }
}
function startPoly(){
    polyDrawing = true;
    polyPoints = [];
    document.getElementById('start-poly-btn').style.display = 'none';
    document.getElementById('end-poly-btn').style.display = '';
}
function endPoly(){
    polyDrawing = false;
    if(currentZoneId) {
        zones[currentZoneId].points = polyPoints.slice();
        // ìµœì´ˆ ì§€ì • í”„ë ˆì„ì— ëŒ€í•´ polyHistory ë“±ë¡
        if (!polyHistory[currentZoneId]) polyHistory[currentZoneId] = {};
        polyHistory[currentZoneId][frameIdx] = polyPoints.slice();
    }
    polyPoints = [];
    drawZones(frameIdx);
    document.getElementById('start-poly-btn').style.display = '';
    document.getElementById('end-poly-btn').style.display = 'none';
}
canvas && canvas.addEventListener('click', (e)=>{
    if (!currentZoneId || !polyDrawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.round((e.clientX-rect.left)*canvas.width/rect.width);
    const y = Math.round((e.clientY-rect.top)*canvas.height/rect.height);
    polyPoints.push([x,y]);
    drawZones(frameIdx);
});

function drawZones(idx) {
    ctx.lineWidth = 2.2;
    // ì ì°ê¸° ì¤‘ ì„ì‹œ í´ë¦¬ê³¤
    if (polyDrawing && polyPoints.length > 0) {
        ctx.beginPath();
        ctx.moveTo(polyPoints[0][0], polyPoints[0][1]);
        for(let i=1;i<polyPoints.length;i++) ctx.lineTo(polyPoints[i][0], polyPoints[i][1]);
        ctx.strokeStyle = "#0bf";
        ctx.stroke();
        for(let p of polyPoints){
            ctx.beginPath(); ctx.arc(p[0],p[1],5,0,2*Math.PI);
            ctx.fillStyle = "#0080ff";
            ctx.fill();
        }
    }
    // í”„ë ˆì„ë³„ polyHistory ìš°ì„  í‘œì‹œ
    Object.entries(zones).forEach(([id, data])=>{
        let drawPts = getPolygonForFrame(id, idx);
        if (!drawPts || drawPts.length < 3) return;
        ctx.beginPath();
        ctx.moveTo(drawPts[0][0], drawPts[0][1]);
        for(let i=1;i<drawPts.length;i++) ctx.lineTo(drawPts[i][0], drawPts[i][1]);
        ctx.closePath();
        ctx.strokeStyle = id==currentZoneId ? "#ff2222" : "#0b6";
        ctx.stroke();
        if (id==currentZoneId) {
            ctx.fillStyle = "rgba(255,0,0,0.12)";
            ctx.fill();
        }
        for(let p of drawPts){
            ctx.beginPath(); ctx.arc(p[0],p[1],5,0,2*Math.PI);
            ctx.fillStyle = id==currentZoneId ? "#ff2222" : "#0057c7";
            ctx.fill();
        }
    });
    document.getElementById('zone-info').innerText =
      currentZoneId ? ("ID: "+currentZoneId+" / ì : "+JSON.stringify(getPolygonForFrame(currentZoneId, idx))) : "";
}
function addNewZone(){
    let newId = "zone" + (Object.keys(zones).length + 1);
    zones[newId] = { points: [], frame: frameIdx };
    if (!polyHistory[newId]) polyHistory[newId] = {};
    currentZoneId = newId;
    updateZoneSelect();
    drawZones(frameIdx);
}
function deleteZone(){
    if (currentZoneId && zones[currentZoneId]) {
        delete zones[currentZoneId];
        delete polyHistory[currentZoneId];
        currentZoneId = null;
        updateZoneSelect();
        drawZones(frameIdx);
    }
}
function editZone(){
    if (currentZoneId && zones[currentZoneId]) {
        zones[currentZoneId].points = [];
        polyHistory[currentZoneId] = {};
        drawZones(frameIdx);
    }
}
function updateZoneSelect(){
    let sel = document.getElementById('zoneSelect');
    sel.innerHTML = "";
    for (let id of Object.keys(zones)) {
        let option = document.createElement("option");
        option.value = id;
        option.text = id;
        sel.appendChild(option);
    }
    sel.value = currentZoneId;
    sel.onchange = ()=>{ currentZoneId = sel.value; drawZones(frameIdx); };
}
// ---- ORB ì „ì²´ ì¶”ì¶œ/ì‹œê°í™” ----
function extractAllORB(){
    document.getElementById('orb-all-status').innerText = "ì¶”ì¶œ ì¤‘...";
    fetch(`/extract_orb_all/${selectedVideo}`).then(res=>res.json()).then(data=>{
        orbAll = data.all_keypoints;
        document.getElementById('orb-all-status').innerText = "ì „ì²´ í”„ë ˆì„ ORB ì™„ë£Œ!";
        document.getElementById('visualize-orb-btn').style.display = "inline-block";
    });
}
function visualizeAllORB(){
    orbViz = true;
    loadFrame(frameIdx);
}
function drawORB(idx){
    ctx.fillStyle = "#0f0";
    (orbAll[idx]||[]).forEach(pt => {
        ctx.beginPath();
        ctx.arc(pt[0], pt[1], 2, 0, 2*Math.PI);
        ctx.fill();
    });
}
function saveDangerZones(){
    fetch("/save_zone", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            filename: selectedVideo,
            zones: zones,
            orb_all: orbAll
        })
    }).then(res=>{
        if (res.ok) alert("ì €ì¥ ì™„ë£Œ!");
        else alert("ì €ì¥ ì‹¤íŒ¨");
    });
}

window.onload = function(){
    if (selectedVideo) {
        makeThumbnails();
        loadFrame(0);
        updateZoneSelect();
        if (Object.keys(zones).length)
            currentZoneId = Object.keys(zones)[0];
        drawZones(frameIdx);
    }
}
</script>
{% endblock %}
